import nltk
from datasets import load_metric
from transformers import GPT2LMHeadModel, GPT2Tokenizer
import torch
import warnings
from rouge_score import rouge_scorer

# Suppress specific warnings
warnings.filterwarnings("ignore", category=FutureWarning, module='huggingface_hub.file_download')
warnings.filterwarnings("ignore", category=UserWarning, module='datasets.load')


nltk.download('punkt')

ground_truths = [
    "The main symptoms of asthma include wheezing, breathlessness, a tight chest (feeling like a band is tightening around it), and coughing. These symptoms can sometimes worsen temporarily, which is known as an asthma attack.",
    "If you think you're having an asthma attack, follow these steps: 1. Sit straight and stay calm. 2. Take one puff of your reliever inhaler every 30-60 seconds, up to a maximum of 10 puffs. 3. If you feel worse or do not feel better after taking 10 puffs, call 999 for an ambulance. 4. If the ambulance has not arrived in 10 minutes and your symptoms are not improving, repeat step 2. 5. If your symptoms are still not improving, contact 999 immediately. 6. Do not hesitate to call for help during an asthma attack. It's also recommended to have your medications and personal asthma action plan to share with healthcare professionals if needed.",
    "Common triggers that can cause asthma symptoms to worsen include cold weather, dust mites, animal dander, and certain medications. It is important to identify and avoid these triggers to manage asthma symptoms effectively. If you suspect a trigger is worsening your symptoms, speak to a doctor or asthma nurse for advice on prevention and management.",
    "Asthma can be diagnosed by a GP through a combination of symptom assessment and simple tests. The GP will likely ask about the frequency of symptoms and potential triggers, such as eczema or allergies. They may also consider family history and suggest tests to confirm asthma. The main tests used to diagnose asthma include the FeNO test, spirometry, and peak flow test. In some cases, a chest X-ray or allergy test may be recommended. If the GP is unsure, they may refer you to a specialist for further evaluation.",
    "The types of inhalers commonly used to treat asthma include beta-2 agonists (like salbutamol, salmeterol, formoterol, and vilanterol), anticholinergics (such as ipratropium and tiotropium), and inhaled corticosteroids. These inhalers help to open up the airways and reduce inflammation in the lungs."
]

# answers generated by your RAG application
generated_answers = [
    "The main symptoms of asthma include wheezing (a whistling sound when breathing), breathlessness, a tight chest (feeling like a band is tightening around it), and coughing. Sometimes these symptoms can worsen temporarily, which is known as an asthma attack.",
    "If you think you're having an asthma attack, you should follow these steps: 1. Sit straight and try to keep calm. 2. Take one puff of your reliever inhaler (usually blue) every 30-60 seconds, up to a maximum of 10 puffs. 3. If you feel worse at any point or do not feel better after taking 10 puffs, call 999 for an ambulance. 4. If the ambulance has not arrived within 10 minutes and your symptoms are not improving, repeat step 2. 5. If your symptoms are still not improving after repeating step 2, contact 999 immediately. 6. Do not hesitate to call for emergency help if needed. Remember, it's important to never be afraid to call for help during an asthma attack. It's also recommended to take note of your medications and personal asthma action plan to share with healthcare professionals if needed.",
    "Common triggers that can cause asthma symptoms to worsen include cold weather, dust mites, animal dander, and certain medications. It is important to identify and avoid these triggers as much as possible to help manage asthma symptoms effectively. If you suspect a trigger is worsening your symptoms, it is advisable to speak to a doctor or asthma nurse for advice on prevention and management.",
    "Asthma can be diagnosed by a GP through a combination of symptoms assessment and simple tests. The GP will likely ask about the frequency of symptoms and potential triggers, such as eczema or allergies. They may also consider family history and may suggest tests to confirm asthma. The main tests used to help diagnose asthma include the FeNO test, spirometry, and peak flow test. In some cases, a chest X-ray or allergy test may also be recommended. If the GP is unsure, they may refer the individual to a specialist for further evaluation.",
    "The types of inhalers commonly used to treat asthma include beta-2 agonists (such as salbutamol, salmeterol, formoterol, and vilanterol), anticholinergics (like ipratropium and tiotropium), and inhaled corticosteroids. These inhalers help to open up the airways and reduce inflammation in the lungs."
]

# Function to calculate BLEU score
def calculate_bleu(ground_truths, generated_answers):
    bleu = load_metric('bleu', trust_remote_code=True)
    references = [[nltk.word_tokenize(gt)] for gt in ground_truths]
    predictions = [nltk.word_tokenize(ga) for ga in generated_answers]
    results = bleu.compute(predictions=predictions, references=references)
    return results['bleu']

# Function to calculate ROUGE scores
def calculate_rouge(ground_truths, generated_answers):
    scorer = rouge_scorer.RougeScorer(['rouge1', 'rouge2', 'rougeL'], use_stemmer=True)
    rouge1_scores = []
    rouge2_scores = []
    rougeL_scores = []
    for gt, ga in zip(ground_truths, generated_answers):
        scores = scorer.score(gt, ga)
        rouge1_scores.append(scores['rouge1'].fmeasure)
        rouge2_scores.append(scores['rouge2'].fmeasure)
        rougeL_scores.append(scores['rougeL'].fmeasure)
    return {
        'rouge1': sum(rouge1_scores) / len(rouge1_scores),
        'rouge2': sum(rouge2_scores) / len(rouge2_scores),
        'rougeL': sum(rougeL_scores) / len(rougeL_scores)
    }

# Function to calculate Perplexity using GPT-2
def calculate_perplexity(generated_answers):
    model = GPT2LMHeadModel.from_pretrained('gpt2')
    tokenizer = GPT2Tokenizer.from_pretrained('gpt2')

    model.eval()

    nlls = []
    for answer in generated_answers:
        inputs = tokenizer(answer, return_tensors='pt')
        with torch.no_grad():
            outputs = model(**inputs, labels=inputs['input_ids'])
            neg_log_likelihood = outputs.loss
        nlls.append(neg_log_likelihood.item())

    ppl = torch.exp(torch.tensor(nlls).mean())
    return ppl.item()

# Calculate metrics
bleu_score = calculate_bleu(ground_truths, generated_answers)
perplexity_score = calculate_perplexity(generated_answers)
rouge_scores = calculate_rouge(ground_truths, generated_answers)

print(f"BLEU Score: {bleu_score}")
print(f"Perplexity Score: {perplexity_score}")
print(f"ROUGE-1 Score: {rouge_scores['rouge1']}")
print(f"ROUGE-2 Score: {rouge_scores['rouge2']}")
print(f"ROUGE-L Score: {rouge_scores['rougeL']}")
